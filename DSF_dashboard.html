<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Thermal Melt Assay Dashboard</title>
		<!-- Tailwind CSS for modern styling -->
		<script src="https://cdn.tailwindcss.com"></script>
		<!-- Chart.js for interactive plotting -->
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@^1.0.0"></script>

		<style>
			/* Simple scrollbar styling for the conditions list */
			.custom-scrollbar::-webkit-scrollbar {
				width: 8px;
			}
			.custom-scrollbar::-webkit-scrollbar-track {
				background: #f1f5f9;
				border-radius: 10px;
			}
			.custom-scrollbar::-webkit-scrollbar-thumb {
				background: #94a3b8;
				border-radius: 10px;
			}
			.custom-scrollbar::-webkit-scrollbar-thumb:hover {
				background: #475569;
			}

			/* Styles for the new collapsible menu */
			#selection-panel {
				max-height: 0;
				overflow: hidden;
				transition:
					max-height 0.4s ease-in-out,
					padding 0.4s ease-in-out;
				padding-top: 0;
				padding-bottom: 0;
			}
			#selection-panel.open {
				/* Calculated height for a responsive panel */
				max-height: calc(100vh - 200px);
				padding-top: 1rem;
				padding-bottom: 1rem;
			}
			.chevron-icon {
				transition: transform 0.3s ease-in-out;
			}
			.menu-open .chevron-icon {
				transform: rotate(180deg);
			}
		</style>
	</head>
	<body class="bg-slate-50 font-sans text-slate-800 flex flex-col h-screen">
		<!-- === HEADER & CONTROLS === -->
		<header class="bg-white border-b border-slate-200 p-4 z-10 shadow-sm">
			<div class="container mx-auto">
				<!-- Top Bar -->
				<div class="flex justify-between items-center">
					<div>
						<h1 class="text-xl font-bold text-slate-900">
							Melt Curve Dashboard
						</h1>
						<p class="text-sm text-slate-500 hidden sm:block">
							Visualize fluorescence thermal melt data.
						</p>
					</div>
					<div class="flex items-center gap-4">
						<div class="flex-shrink-0">
							<label
								for="csvFileInput"
								class="text-sm font-medium text-slate-700"
								>Upload CSV:</label
							>
							<input
								type="file"
								id="csvFileInput"
								accept=".csv"
								class="ml-2 w-48 text-sm text-slate-500 file:mr-2 file:py-1 file:px-3 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition-colors duration-200 cursor-pointer"
							/>
						</div>
						<button
							id="toggle-menu-btn"
							class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-md text-sm font-semibold text-slate-700 transition-colors"
						>
							<span>Select Conditions</span>
							<svg
								class="chevron-icon w-5 h-5"
								xmlns="http://www.w3.org/2000/svg"
								viewBox="0 0 20 20"
								fill="currentColor"
							>
								<path
									fill-rule="evenodd"
									d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
									clip-rule="evenodd"
								/>
							</svg>
						</button>
					</div>
				</div>
				<!-- Collapsible Selection Panel -->
				<div id="selection-panel">
					<div class="border-t border-slate-200 mt-4 pt-4">
						<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
							<div class="md:col-span-1">
								<label for="search-input" class="sr-only">Search</label>
								<input
									type="search"
									id="search-input"
									placeholder="Search conditions..."
									class="w-full px-3 py-2 text-sm border border-slate-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
								/>
								<div class="flex justify-start space-x-4 mt-2">
									<button
										id="selectAllBtn"
										class="text-xs font-semibold text-indigo-600 hover:text-indigo-800 transition-colors"
									>
										Select All Visible
									</button>
									<button
										id="deselectAllBtn"
										class="text-xs font-semibold text-indigo-600 hover:text-indigo-800 transition-colors"
									>
										Deselect All Visible
									</button>
								</div>
							</div>
							<div
								id="conditions-list"
								class="md:col-span-2 max-h-64 overflow-y-auto border border-slate-200 rounded-lg p-2 bg-slate-50 custom-scrollbar"
							>
								<p
									id="conditions-placeholder"
									class="text-center text-slate-500 text-sm p-4"
								>
									Upload a CSV to see conditions.
								</p>
							</div>
						</div>
					</div>
				</div>
			</div>
		</header>

		<!-- === MAIN CHART AREA === -->
		<main class="flex-grow p-4 md:p-6 flex items-center justify-center min-h-0">
			<div
				id="chart-container"
				class="w-full h-full bg-white rounded-lg shadow-md p-4"
			>
				<canvas id="meltChart"></canvas>
			</div>
			<div id="initial-message" class="text-center text-slate-500">
				<p class="text-lg">Loading initial data...</p>
			</div>
		</main>

		<script>
			// === DOM ELEMENT REFERENCES ===
			const csvFileInput = document.getElementById('csvFileInput');
			const conditionsList = document.getElementById('conditions-list');
			const chartContainer = document.getElementById('chart-container');
			const initialMessage = document.getElementById('initial-message');
			const selectAllBtn = document.getElementById('selectAllBtn');
			const deselectAllBtn = document.getElementById('deselectAllBtn');
			const searchInput = document.getElementById('search-input');
			const toggleMenuBtn = document.getElementById('toggle-menu-btn');
			const selectionPanel = document.getElementById('selection-panel');
			const conditionsPlaceholder = document.getElementById(
				'conditions-placeholder'
			);
			const ctx = document.getElementById('meltChart').getContext('2d');

			// === GLOBAL STATE ===
			let meltChart = null;
			let parsedData = [];
			const CHART_COLORS = [
				'#4f46e5',
				'#db2777',
				'#16a34a',
				'#f97316',
				'#0891b2',
				'#7c3aed',
				'#ca8a04',
				'#65a30d',
				'#be185d',
				'#059669',
				'#ea580c',
				'#4338ca',
				'#0d9488',
				'#d946ef',
				'#e11d48',
				'#fbbf24'
			];

			/** Main initialization function */
			async function init() {
				chartContainer.style.display = 'none';

				// Event Listeners
				csvFileInput.addEventListener('change', handleFileSelect);
				conditionsList.addEventListener('change', updateChartDatasets);
				selectAllBtn.addEventListener('click', () =>
					toggleAllVisibleCheckboxes(true)
				);
				deselectAllBtn.addEventListener('click', () =>
					toggleAllVisibleCheckboxes(false)
				);
				searchInput.addEventListener('input', handleSearchFilter);
				toggleMenuBtn.addEventListener('click', () => {
					selectionPanel.classList.toggle('open');
					toggleMenuBtn.classList.toggle('menu-open');
				});

				// Load initial data
				try {
					const response = await fetch(
						'250923_Sun2-335-717_buffer_screen_dRFU_long.csv'
					);
					if (!response.ok)
						throw new Error(`HTTP error! status: ${response.status}`);
					const csvText = await response.text();
					processCSV(csvText);
				} catch (error) {
					console.error('Error loading initial data:', error);
					initialMessage.innerHTML = `<p class="text-red-500">Could not load initial data. Please upload a file.</p>`;
					conditionsPlaceholder.textContent = 'Ready for file upload.';
				}
			}

			/** Handles the file input change event */
			function handleFileSelect(event) {
				const file = event.target.files[0];
				if (!file) return;
				const reader = new FileReader();
				reader.onload = (e) => processCSV(e.target.result);
				reader.onerror = (e) => {
					console.error('File reading error', e);
					alert('Error reading file.');
				};
				reader.readAsText(file);
			}

			/** Processes the raw CSV string */
			function processCSV(csvText) {
				try {
					const lines = csvText.trim().split(/\r?\n/);
					const headers = lines[0].split(',').slice(1).map(Number);

					parsedData = lines.slice(1).map((line, originalIndex) => {
						const values = line.split(',');
						const condition = values[0];
						const points = values
							.slice(1)
							.map((val, index) => ({ x: headers[index], y: parseFloat(val) }));
						return { condition, data: points, originalIndex };
					});

					populateConditionsList();
					createOrUpdateChart();

					initialMessage.style.display = 'none';
					chartContainer.style.display = 'block';
				} catch (error) {
					console.error('Error parsing CSV:', error);
					alert(
						'Failed to parse CSV. Please ensure it is formatted correctly.'
					);
					initialMessage.style.display = 'block';
					initialMessage.innerHTML = `<p class="text-red-500">Failed to parse file.</p>`;
					chartContainer.style.display = 'none';
					conditionsList.innerHTML = '';
					conditionsPlaceholder.textContent = 'Upload a CSV to see conditions.';
				}
			}

			/** Populates the sidebar with a flat list of checkboxes */
			function populateConditionsList() {
				conditionsList.innerHTML = ''; // Clear previous list
				parsedData.forEach((item, index) => {
					const div = document.createElement('div');
					div.className =
						'condition-item flex items-center p-1.5 rounded-md hover:bg-slate-200 transition-colors';
					div.dataset.conditionName = item.condition.toLowerCase();

					const checkbox = document.createElement('input');
					checkbox.type = 'checkbox';
					checkbox.id = `condition-${index}`;
					checkbox.value = index;
					checkbox.checked = index < 3; // Check first 3 by default
					checkbox.className =
						'condition-checkbox h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500';

					const label = document.createElement('label');
					label.htmlFor = `condition-${index}`;
					label.textContent = item.condition;
					label.className =
						'ml-3 block text-sm text-slate-700 truncate cursor-pointer';

					div.appendChild(checkbox);
					div.appendChild(label);
					conditionsList.appendChild(div);
				});
			}

			/** Filters the conditions list based on search input */
			function handleSearchFilter() {
				const searchTerm = searchInput.value.toLowerCase();
				document.querySelectorAll('.condition-item').forEach((itemEl) => {
					const isMatch = itemEl.dataset.conditionName.includes(searchTerm);
					itemEl.style.display = isMatch ? 'flex' : 'none';
				});
			}

			/** Creates or updates the chart instance */
			function createOrUpdateChart() {
				if (meltChart) meltChart.destroy();
				meltChart = new Chart(ctx, {
					type: 'line',
					data: { datasets: getSelectedDatasets() },
					options: {
						responsive: true,
						maintainAspectRatio: false,
						scales: {
							x: {
								type: 'linear',
								title: {
									display: true,
									text: 'Temperature (°C)',
									font: { size: 14, weight: '500' },
									color: '#475569'
								},
								grid: { color: '#e2e8f0' },
								ticks: { color: '#64748b' }
							},
							y: {
								title: {
									display: true,
									text: 'dRFU',
									font: { size: 14, weight: '500' },
									color: '#475569'
								},
								grid: { color: '#e2e8f0' },
								ticks: { color: '#64748b' }
							}
						},
						plugins: {
							legend: {
								position: 'top',
								labels: { color: '#475569', usePointStyle: true }
							},
							tooltip: {
								mode: 'index',
								intersect: false,
								backgroundColor: '#fff',
								titleColor: '#334155',
								bodyColor: '#475569',
								borderColor: '#e2e8f0',
								borderWidth: 1,
								callbacks: {
									title: (tooltipItems) => `Temp: ${tooltipItems[0].parsed.x}°C`
								}
							}
						},
						interaction: { mode: 'nearest', axis: 'x', intersect: false }
					}
				});
			}

			/** Updates the chart's visible datasets */
			function updateChartDatasets() {
				if (!meltChart) return;
				meltChart.data.datasets = getSelectedDatasets();
				meltChart.update();
			}

			/** Gets dataset objects for currently checked conditions */
			function getSelectedDatasets() {
				const selectedDatasets = [];
				const checkboxes = conditionsList.querySelectorAll(
					'.condition-checkbox:checked'
				);
				checkboxes.forEach((checkbox) => {
					const dataIndex = parseInt(checkbox.value);
					const item = parsedData[dataIndex];
					if (item) {
						selectedDatasets.push({
							label: item.condition,
							data: item.data,
							borderColor: CHART_COLORS[dataIndex % CHART_COLORS.length],
							backgroundColor:
								CHART_COLORS[dataIndex % CHART_COLORS.length] + '33',
							borderWidth: 2,
							pointRadius: 0,
							pointHoverRadius: 5,
							fill: false,
							tension: 0.1
						});
					}
				});
				return selectedDatasets;
			}

			/** Toggles all VISIBLE condition checkboxes on or off */
			function toggleAllVisibleCheckboxes(checkedState) {
				document.querySelectorAll('.condition-item').forEach((item) => {
					if (item.style.display !== 'none') {
						const checkbox = item.querySelector('.condition-checkbox');
						if (checkbox) checkbox.checked = checkedState;
					}
				});
				updateChartDatasets();
			}

			// Run initialization
			document.addEventListener('DOMContentLoaded', init);
		</script>
	</body>
</html>
